<!DOCTYPE html>
<html>

<body>
    <script src="js/jquery.min.js"></script>
    <script src="js/papaparse.min.js"></script>
    <script>
        const Categories = ['Vowels', 'Dipthong', 'R_Colored', 'Stops', 'Nasal', 'FricativeAndAffricate', 'Approximant'];
        const database = [];
        const Vowels = [];
        const Dipthong = [];
        const R_Colored = [];
        const Stops = [];
        const Nasal = [];
        const FricativeAndAffricate = [];
        const Approximant = [];

        function loadDataFromCSV() {
            for (var i = 0; i < Categories.length; i++) {
                var completeFn = eval(functionStringGenerator(Categories[i]));
                $.get(urlStringGenerator(Categories[i]), function (data) {
                    Papa.parse(data, {
                        complete: completeFn
                    });
                })
            }
            console.log("database after load:", database)

        }

        // unused, just for comprehension, has the same logic with functionStringGenerator
        function completeFnExample(category) {
            return function (results, file) {
                console.log("Parsing complete:", results, file);
                for (var i = 0; i < results.data[0].length; i++) {
                    category.push({ Phoneme: results.data[0][i], Vocabulary: [] });
                    // each 2 consecutive symbols are same, one for words, one for phonetic symbols
                    i++;
                };
                for (var i = 1; i < results.data.length; i++) {
                    for (var j = 0; j < results.data[i].length; j++) {
                        if (results.data[i][j].length > 0) {
                            category[j / 2].Vocabulary.push([results.data[i][j], results.data[i][++j]]);
                        }
                    }
                };
                console.log("Loaded category:", category);
                database.push(category);
            }
        }

        function functionStringGenerator(category) {
            return '(function(a,o) {console.log("Parsing complete:",a,o);for(var t=0;t<a.data[0].length;t++) ' + category + '.push({Phoneme:a.data[0][t],Vocabulary:[]}),t++;for(var t=1;t<a.data.length;t++)for(var e=0;e<a.data[t].length;e++)a.data[t][e].length>0&& ' + category + '[e/2].Vocabulary.push([a.data[t][e],a.data[t][++e]]);console.log("Loaded category:", category, ' + category + ' ); database.push(' + category + ');})';
        }

        // remember to modify the url after forking
        function urlStringGenerator(category) {
            return 'https://raw.githack.com/Hunter-Plus/AmericanAccentTrainerWithGoogle/main/vocabulary/{{category}}.csv'.replace("{{category}}", category);
        }
    </script>
    <script>
        var current_category = 0;
        var current_sub_category = 0;
        var current_index = 0;

        // index_offset == 1, go next page, == 0, go back to last one
        function whenChangePage(category, index_offset) {
            if (category >= 0) {
                current_category = category;
                current_sub_category = 0;
                current_index = 0;
            } else {
                if (index_offset < 0) {
                    if (current_index == 0 && current_sub_category == 0) {
                        window.alert("This is the first word! Cannot going back!");
                        return 0;
                    }
                    if (current_index == 0) {
                        // go back to last one sub category
                        current_sub_category--;
                        current_index = database[current_category][current_sub_category].length;
                    }
                    current_index--;
                } else {
                    if (current_index == database[current_category][current_sub_category].length - 1) {
                        if (current_sub_category == database[current_category].length - 1) {
                            window.alert("No more word in this category! Good job!");
                            return 0;
                        }
                        // go to next sub category
                        ++current_sub_category;
                        current_index = -1;
                    }
                    ++current_index;
                }
            }

            window.open('https://www.google.com/search?q=' + database[current_category][current_sub_category].Vocabulary[current_index][0] + '+pronunciation', 'new', 'popup'); return false;
            return 0;
        }

    </script>
    <h1>Perfect Pronunciation With Google</h1>
    <a href='https://www.google.com/search?q=${current_word}+pronunciation'
        onclick="window.open(this.href, 'new', 'popup'); return false;">
        Next
    </a>

    <button onclick="whenChangePage(0, 1)">
        Last
    </button>
    <button onclick="loadDataFromCSV()">
        Try load
    </button>

</body>

</html>